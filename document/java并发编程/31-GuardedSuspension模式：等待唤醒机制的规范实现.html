<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>31-GuardedSuspensionæ¨¡å¼ï¼šç­‰å¾…å”¤é†’æœºåˆ¶çš„è§„èŒƒå®ç°</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>31-GuardedSuspensionæ¨¡å¼ï¼šç­‰å¾…å”¤é†’æœºåˆ¶çš„è§„èŒƒå®ç°</h1>
<p>å‰ä¸ä¹…ï¼ŒåŒäº‹å°ç°å·¥ä½œä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œä»–å¼€å‘äº†ä¸€ä¸ªWebé¡¹ç›®ï¼šWebç‰ˆçš„æ–‡ä»¶æµè§ˆå™¨ï¼Œé€šè¿‡å®ƒç”¨æˆ·å¯ä»¥åœ¨æµè§ˆå™¨é‡ŒæŸ¥çœ‹æœåŠ¡å™¨ä¸Šçš„ç›®å½•å’Œæ–‡ä»¶ã€‚è¿™ä¸ªé¡¹ç›®ä¾èµ–è¿ç»´éƒ¨é—¨æä¾›çš„æ–‡ä»¶æµè§ˆæœåŠ¡ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶æµè§ˆæœåŠ¡åªæ”¯æŒæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰æ–¹å¼æ¥å…¥ã€‚æ¶ˆæ¯é˜Ÿåˆ—åœ¨äº’è”ç½‘å¤§å‚ä¸­ç”¨çš„éå¸¸å¤šï¼Œä¸»è¦ç”¨ä½œæµé‡å‰Šå³°å’Œç³»ç»Ÿè§£è€¦ã€‚åœ¨è¿™ç§æ¥å…¥æ–¹å¼ä¸­ï¼Œå‘é€æ¶ˆæ¯å’Œæ¶ˆè´¹ç»“æœè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´æ˜¯å¼‚æ­¥çš„ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºæ„å›¾æ¥ç†è§£ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/d1/21/d1ad5ce1df66d85698308c41e4e93a21.png" alt=""></p><center><span class="reference">æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰ç¤ºæ„å›¾</span></center><p>åœ¨å°ç°çš„è¿™ä¸ªWebé¡¹ç›®ä¸­ï¼Œç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘è¿‡æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šè¢«è½¬æ¢æˆä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯å‘é€ç»™MQï¼Œç­‰MQè¿”å›ç»“æœåï¼Œå†å°†è¿™ä¸ªç»“æœè¿”å›è‡³æµè§ˆå™¨ã€‚å°ç°åŒå­¦çš„é—®é¢˜æ˜¯ï¼šç»™MQå‘é€æ¶ˆæ¯çš„çº¿ç¨‹æ˜¯å¤„ç†Webè¯·æ±‚çš„çº¿ç¨‹T1ï¼Œä½†æ¶ˆè´¹MQç»“æœçš„çº¿ç¨‹å¹¶ä¸æ˜¯çº¿ç¨‹T1ï¼Œé‚£çº¿ç¨‹T1å¦‚ä½•ç­‰å¾…MQçš„è¿”å›ç»“æœå‘¢ï¼Ÿä¸ºäº†ä¾¿äºä½ ç†è§£è¿™ä¸ªåœºæ™¯ï¼Œæˆ‘å°†å…¶ä»£ç åŒ–äº†ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>class Message{
  String id;
  String content;
}
//è¯¥æ–¹æ³•å¯ä»¥å‘é€æ¶ˆæ¯
void send(Message msg){
  //çœç•¥ç›¸å…³ä»£ç 
}
//MQæ¶ˆæ¯è¿”å›åä¼šè°ƒç”¨è¯¥æ–¹æ³•
//è¯¥æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹ä¸åŒäº
//å‘é€æ¶ˆæ¯çš„çº¿ç¨‹
void onMessage(Message msg){
  //çœç•¥ç›¸å…³ä»£ç 
}
//å¤„ç†æµè§ˆå™¨å‘æ¥çš„è¯·æ±‚
Respond handleWebReq(){
  //åˆ›å»ºä¸€æ¶ˆæ¯
  Message msg1 = new 
    Message(&quot;1&quot;,&quot;{...}&quot;);
  //å‘é€æ¶ˆæ¯
  send(msg1);
  //å¦‚ä½•ç­‰å¾…MQè¿”å›çš„æ¶ˆæ¯å‘¢ï¼Ÿ
  String result = ...;
}
</code></pre><p>çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ ä¸€å®šæœ‰ç‚¹ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œè¿™ä¸å°±æ˜¯å‰é¢æˆ‘ä»¬åœ¨<a href="https://time.geekbang.org/column/article/88487">ã€Š15 | Lockå’ŒConditionï¼ˆä¸‹ï¼‰ï¼šDubboå¦‚ä½•ç”¨ç®¡ç¨‹å®ç°å¼‚æ­¥è½¬åŒæ­¥ï¼Ÿã€‹</a>ä¸­æ›¾ä»‹ç»è¿‡çš„å¼‚æ­¥è½¬åŒæ­¥é—®é¢˜å—ï¼Ÿä»”ç»†åˆ†æï¼Œçš„ç¡®æ˜¯è¿™æ ·ï¼Œä¸è¿‡åœ¨é‚£ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åªæ˜¯ä»‹ç»äº†æœ€ç»ˆæ–¹æ¡ˆï¼Œè®©ä½ çŸ¥å…¶ç„¶ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»‹ç»è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦‚ä½•è®¾è®¡å‡ºæ¥çš„ï¼Œä»Šå¤©å’±ä»¬å†ä»”ç»†èŠèŠè¿™ä¸ªé—®é¢˜ï¼Œè®©ä½ çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œé‡åˆ°ç±»ä¼¼é—®é¢˜ä¹Ÿèƒ½è‡ªå·±è®¾è®¡å‡ºæ–¹æ¡ˆæ¥ã€‚</p><!-- [[[read_end]]] --><h2>Guarded Suspensionæ¨¡å¼</h2><p>ä¸Šé¢å°ç°é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨ç°å®ä¸–ç•Œé‡Œæ¯”æ¯”çš†æ˜¯ï¼Œåªæ˜¯æˆ‘ä»¬ä¸€ä¸å°å¿ƒå°±å¿½ç•¥äº†ã€‚æ¯”å¦‚ï¼Œé¡¹ç›®ç»„å›¢å»ºè¦å¤–å‡ºèšé¤ï¼Œæˆ‘ä»¬æå‰é¢„è®¢äº†ä¸€ä¸ªåŒ…é—´ï¼Œç„¶åå…´å†²å†²åœ°å¥”è¿‡å»ï¼Œåˆ°é‚£å„¿åå¤§å ‚ç»ç†çœ‹äº†ä¸€çœ¼åŒ…é—´ï¼Œå‘ç°æœåŠ¡å‘˜æ­£åœ¨æ”¶æ‹¾ï¼Œå°±ä¼šå‘Šè¯‰æˆ‘ä»¬ï¼šâ€œæ‚¨é¢„è®¢çš„åŒ…é—´æœåŠ¡å‘˜æ­£åœ¨æ”¶æ‹¾ï¼Œè¯·æ‚¨ç¨ç­‰ç‰‡åˆ»ã€‚â€è¿‡äº†ä¸€ä¼šï¼Œå¤§å ‚ç»ç†å‘ç°åŒ…é—´å·²ç»æ”¶æ‹¾å®Œäº†ï¼Œäºæ˜¯é©¬ä¸Šå¸¦æˆ‘ä»¬å»åŒ…é—´å°±é¤ã€‚</p><p>æˆ‘ä»¬ç­‰å¾…åŒ…é—´æ”¶æ‹¾å®Œçš„è¿™ä¸ªè¿‡ç¨‹å’Œå°ç°é‡åˆ°çš„ç­‰å¾…MQè¿”å›æ¶ˆæ¯æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯<strong>ç­‰å¾…ä¸€ä¸ªæ¡ä»¶æ»¡è¶³</strong>ï¼šå°±é¤éœ€è¦ç­‰å¾…åŒ…é—´æ”¶æ‹¾å®Œï¼Œå°ç°çš„ç¨‹åºé‡Œè¦ç­‰å¾…MQè¿”å›æ¶ˆæ¯ã€‚</p><p>é‚£æˆ‘ä»¬æ¥çœ‹çœ‹ç°å®ä¸–ç•Œé‡Œæ˜¯å¦‚ä½•è§£å†³è¿™ç±»é—®é¢˜çš„å‘¢ï¼Ÿç°å®ä¸–ç•Œé‡Œå¤§å ‚ç»ç†è¿™ä¸ªè§’è‰²å¾ˆé‡è¦ï¼Œæˆ‘ä»¬æ˜¯å¦ç­‰å¾…ï¼Œå®Œå…¨æ˜¯ç”±ä»–æ¥åè°ƒçš„ã€‚é€šè¿‡ç±»æ¯”ï¼Œç›¸ä¿¡ä½ ä¹Ÿä¸€å®šæœ‰æ€è·¯äº†ï¼šæˆ‘ä»¬çš„ç¨‹åºé‡Œï¼Œä¹Ÿéœ€è¦è¿™æ ·ä¸€ä¸ªå¤§å ‚ç»ç†ã€‚çš„ç¡®æ˜¯è¿™æ ·ï¼Œé‚£ç¨‹åºä¸–ç•Œé‡Œçš„å¤§å ‚ç»ç†è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿå…¶å®è®¾è®¡æ–¹æ¡ˆå‰äººæ—©å°±æå®šäº†ï¼Œè€Œä¸”è¿˜å°†å…¶æ€»ç»“æˆäº†ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼š<strong>Guarded Suspension</strong>ã€‚æ‰€è°“Guarded Suspensionï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯â€œä¿æŠ¤æ€§åœ°æš‚åœâ€ã€‚é‚£ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼ŒGuarded Suspensionæ¨¡å¼æ˜¯å¦‚ä½•æ¨¡æ‹Ÿå¤§å ‚ç»ç†è¿›è¡Œä¿æŠ¤æ€§åœ°æš‚åœçš„ã€‚</p><p>ä¸‹å›¾å°±æ˜¯Guarded Suspensionæ¨¡å¼çš„ç»“æ„å›¾ï¼Œéå¸¸ç®€å•ï¼Œä¸€ä¸ªå¯¹è±¡GuardedObjectï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡â€”â€”å—ä¿æŠ¤çš„å¯¹è±¡ï¼Œä»¥åŠä¸¤ä¸ªæˆå‘˜æ–¹æ³•â€”â€”<code>get(Predicate&lt;T&gt; p)</code>å’Œ<code>onChanged(T obj)</code>æ–¹æ³•ã€‚å…¶ä¸­ï¼Œå¯¹è±¡GuardedObjectå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„å¤§å ‚ç»ç†ï¼Œå—ä¿æŠ¤å¯¹è±¡å°±æ˜¯é¤å…é‡Œé¢çš„åŒ…é—´ï¼›å—ä¿æŠ¤å¯¹è±¡çš„get()æ–¹æ³•å¯¹åº”çš„æ˜¯æˆ‘ä»¬çš„å°±é¤ï¼Œå°±é¤çš„å‰ææ¡ä»¶æ˜¯åŒ…é—´å·²ç»æ”¶æ‹¾å¥½äº†ï¼Œå‚æ•°på°±æ˜¯ç”¨æ¥æè¿°è¿™ä¸ªå‰ææ¡ä»¶çš„ï¼›å—ä¿æŠ¤å¯¹è±¡çš„onChanged()æ–¹æ³•å¯¹åº”çš„æ˜¯æœåŠ¡å‘˜æŠŠåŒ…é—´æ”¶æ‹¾å¥½äº†ï¼Œé€šè¿‡onChanged()æ–¹æ³•å¯ä»¥fireä¸€ä¸ªäº‹ä»¶ï¼Œè€Œè¿™ä¸ªäº‹ä»¶å¾€å¾€èƒ½æ”¹å˜å‰ææ¡ä»¶pçš„è®¡ç®—ç»“æœã€‚ä¸‹å›¾ä¸­ï¼Œå·¦ä¾§çš„ç»¿è‰²çº¿ç¨‹å°±æ˜¯éœ€è¦å°±é¤çš„é¡¾å®¢ï¼Œè€Œå³ä¾§çš„è“è‰²çº¿ç¨‹å°±æ˜¯æ”¶æ‹¾åŒ…é—´çš„æœåŠ¡å‘˜ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/63/dc/630f3eda98a0e6a436953153c68464dc.png" alt=""></p><center><span class="reference">Guarded Suspensionæ¨¡å¼ç»“æ„å›¾</span></center><p>GuardedObjectçš„å†…éƒ¨å®ç°éå¸¸ç®€å•ï¼Œæ˜¯ç®¡ç¨‹çš„ä¸€ä¸ªç»å…¸ç”¨æ³•ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œæ ¸å¿ƒæ˜¯ï¼šget()æ–¹æ³•é€šè¿‡æ¡ä»¶å˜é‡çš„await()æ–¹æ³•å®ç°ç­‰å¾…ï¼ŒonChanged()æ–¹æ³•é€šè¿‡æ¡ä»¶å˜é‡çš„signalAll()æ–¹æ³•å®ç°å”¤é†’åŠŸèƒ½ã€‚é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ã€‚</p><pre><code>class GuardedObject&lt;T&gt;{
  //å—ä¿æŠ¤çš„å¯¹è±¡
  T obj;
  final Lock lock = 
    new ReentrantLock();
  final Condition done =
    lock.newCondition();
  final int timeout=1;
  //è·å–å—ä¿æŠ¤å¯¹è±¡  
  T get(Predicate&lt;T&gt; p) {
    lock.lock();
    try {
      //MESAç®¡ç¨‹æ¨èå†™æ³•
      while(!p.test(obj)){
        done.await(timeout, 
          TimeUnit.SECONDS);
      }
    }catch(InterruptedException e){
      throw new RuntimeException(e);
    }finally{
      lock.unlock();
    }
    //è¿”å›éç©ºçš„å—ä¿æŠ¤å¯¹è±¡
    return obj;
  }
  //äº‹ä»¶é€šçŸ¥æ–¹æ³•
  void onChanged(T obj) {
    lock.lock();
    try {
      this.obj = obj;
      done.signalAll();
    } finally {
      lock.unlock();
    }
  }
}
</code></pre><h2>æ‰©å±•Guarded Suspensionæ¨¡å¼</h2><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†Guarded Suspensionæ¨¡å¼åŠå…¶å®ç°ï¼Œè¿™ä¸ªæ¨¡å¼èƒ½å¤Ÿæ¨¡æ‹Ÿç°å®ä¸–ç•Œé‡Œå¤§å ‚ç»ç†çš„è§’è‰²ï¼Œé‚£ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªâ€œå¤§å ‚ç»ç†â€èƒ½å¦è§£å†³å°ç°åŒå­¦é‡åˆ°çš„é—®é¢˜ã€‚</p><p>Guarded Suspensionæ¨¡å¼é‡ŒGuardedObjectæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯get()æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯onChanged()æ–¹æ³•ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨å¤„ç†Webè¯·æ±‚çš„æ–¹æ³•handleWebReq()ä¸­ï¼Œå¯ä»¥è°ƒç”¨GuardedObjectçš„get()æ–¹æ³•æ¥å®ç°ç­‰å¾…ï¼›åœ¨MQæ¶ˆæ¯çš„æ¶ˆè´¹æ–¹æ³•onMessage()ä¸­ï¼Œå¯ä»¥è°ƒç”¨GuardedObjectçš„onChanged()æ–¹æ³•æ¥å®ç°å”¤é†’ã€‚</p><pre><code>//å¤„ç†æµè§ˆå™¨å‘æ¥çš„è¯·æ±‚
Respond handleWebReq(){
  //åˆ›å»ºä¸€æ¶ˆæ¯
  Message msg1 = new 
    Message(&quot;1&quot;,&quot;{...}&quot;);
  //å‘é€æ¶ˆæ¯
  send(msg1);
  //åˆ©ç”¨GuardedObjectå®ç°ç­‰å¾…
  GuardedObject&lt;Message&gt; go
    =new GuardObjec&lt;&gt;();
  Message r = go.get(
    t-&gt;t != null);
}
void onMessage(Message msg){
  //å¦‚ä½•æ‰¾åˆ°åŒ¹é…çš„goï¼Ÿ
  GuardedObject&lt;Message&gt; go=???
  go.onChanged(msg);
}
</code></pre><p>ä½†æ˜¯åœ¨å®ç°çš„æ—¶å€™ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒhandleWebReq()é‡Œé¢åˆ›å»ºäº†GuardedObjectå¯¹è±¡çš„å®ä¾‹goï¼Œå¹¶è°ƒç”¨å…¶get()æ–¹ç­‰å¾…ç»“æœï¼Œé‚£åœ¨onMessage()æ–¹æ³•ä¸­ï¼Œå¦‚ä½•æ‰èƒ½å¤Ÿæ‰¾åˆ°åŒ¹é…çš„GuardedObjectå¯¹è±¡å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼æœåŠ¡å‘˜å‘Šè¯‰å¤§å ‚ç»ç†æŸæŸåŒ…é—´å·²ç»æ”¶æ‹¾å¥½äº†ï¼Œå¤§å ‚ç»ç†å¦‚ä½•æ ¹æ®åŒ…é—´æ‰¾åˆ°å°±é¤çš„äººã€‚ç°å®ä¸–ç•Œé‡Œï¼Œå¤§å ‚ç»ç†çš„å¤´è„‘ä¸­ï¼Œæœ‰åŒ…é—´å’Œå°±é¤äººä¹‹é—´çš„å…³ç³»å›¾ï¼Œæ‰€ä»¥æœåŠ¡å‘˜è¯´å®Œä¹‹åå¤§å ‚ç»ç†ç«‹åˆ»å°±èƒ½æŠŠå°±é¤äººæ‰¾å‡ºæ¥ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒå¤§å ‚ç»ç†è¯†åˆ«å°±é¤äººçš„åŠæ³•ï¼Œæ¥æ‰©å±•ä¸€ä¸‹Guarded Suspensionæ¨¡å¼ï¼Œä»è€Œä½¿å®ƒèƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è§£å†³å°ç°åŒå­¦çš„é—®é¢˜ã€‚åœ¨å°ç°çš„ç¨‹åºä¸­ï¼Œæ¯ä¸ªå‘é€åˆ°MQçš„æ¶ˆæ¯ï¼Œéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ€§çš„å±æ€§idï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªMQæ¶ˆæ¯idå’ŒGuardedObjectå¯¹è±¡å®ä¾‹çš„å…³ç³»ï¼Œè¿™ä¸ªå…³ç³»å¯ä»¥ç±»æ¯”å¤§å ‚ç»ç†å¤§è„‘é‡Œç»´æŠ¤çš„åŒ…é—´å’Œå°±é¤äººçš„å…³ç³»ã€‚</p><p>æœ‰äº†è¿™ä¸ªå…³ç³»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“å¦‚ä½•å®ç°ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯æ‰©å±•Guarded Suspensionæ¨¡å¼çš„å®ç°ï¼Œæ‰©å±•åçš„GuardedObjectå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªMapï¼Œå…¶Keyæ˜¯MQæ¶ˆæ¯idï¼Œè€ŒValueæ˜¯GuardedObjectå¯¹è±¡å®ä¾‹ï¼ŒåŒæ—¶å¢åŠ äº†é™æ€æ–¹æ³•create()å’ŒfireEvent()ï¼›create()æ–¹æ³•ç”¨æ¥åˆ›å»ºä¸€ä¸ªGuardedObjectå¯¹è±¡å®ä¾‹ï¼Œå¹¶æ ¹æ®keyå€¼å°†å…¶åŠ å…¥åˆ°Mapä¸­ï¼Œè€ŒfireEvent()æ–¹æ³•åˆ™æ˜¯æ¨¡æ‹Ÿçš„å¤§å ‚ç»ç†æ ¹æ®åŒ…é—´æ‰¾å°±é¤äººçš„é€»è¾‘ã€‚</p><pre><code>class GuardedObject&lt;T&gt;{
  //å—ä¿æŠ¤çš„å¯¹è±¡
  T obj;
  final Lock lock = 
    new ReentrantLock();
  final Condition done =
    lock.newCondition();
  final int timeout=2;
  //ä¿å­˜æ‰€æœ‰GuardedObject
  final static Map&lt;Object, GuardedObject&gt; 
  gos=new ConcurrentHashMap&lt;&gt;();
  //é™æ€æ–¹æ³•åˆ›å»ºGuardedObject
  static &lt;K&gt; GuardedObject 
      create(K key){
    GuardedObject go=new GuardedObject();
    gos.put(key, go);
    return go;
  }
  static &lt;K, T&gt; void 
      fireEvent(K key, T obj){
    GuardedObject go=gos.remove(key);
    if (go != null){
      go.onChanged(obj);
    }
  }
  //è·å–å—ä¿æŠ¤å¯¹è±¡  
  T get(Predicate&lt;T&gt; p) {
    lock.lock();
    try {
      //MESAç®¡ç¨‹æ¨èå†™æ³•
      while(!p.test(obj)){
        done.await(timeout, 
          TimeUnit.SECONDS);
      }
    }catch(InterruptedException e){
      throw new RuntimeException(e);
    }finally{
      lock.unlock();
    }
    //è¿”å›éç©ºçš„å—ä¿æŠ¤å¯¹è±¡
    return obj;
  }
  //äº‹ä»¶é€šçŸ¥æ–¹æ³•
  void onChanged(T obj) {
    lock.lock();
    try {
      this.obj = obj;
      done.signalAll();
    } finally {
      lock.unlock();
    }
  }
}
</code></pre><p>è¿™æ ·åˆ©ç”¨æ‰©å±•åçš„GuardedObjectæ¥è§£å†³å°ç°åŒå­¦çš„é—®é¢˜å°±å¾ˆç®€å•äº†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//å¤„ç†æµè§ˆå™¨å‘æ¥çš„è¯·æ±‚
Respond handleWebReq(){
  int id=åºå·ç”Ÿæˆå™¨.get();
  //åˆ›å»ºä¸€æ¶ˆæ¯
  Message msg1 = new 
    Message(id,&quot;{...}&quot;);
  //åˆ›å»ºGuardedObjectå®ä¾‹
  GuardedObject&lt;Message&gt; go=
    GuardedObject.create(id);  
  //å‘é€æ¶ˆæ¯
  send(msg1);
  //ç­‰å¾…MQæ¶ˆæ¯
  Message r = go.get(
    t-&gt;t != null);  
}
void onMessage(Message msg){
  //å”¤é†’ç­‰å¾…çš„çº¿ç¨‹
  GuardedObject.fireEvent(
    msg.id, msg);
}
</code></pre><h2>æ€»ç»“</h2><p>Guarded Suspensionæ¨¡å¼æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç­‰å¾…å”¤é†’æœºåˆ¶çš„å®ç°ï¼Œåªä¸è¿‡Guarded Suspensionæ¨¡å¼å°†å…¶è§„èŒƒåŒ–äº†ã€‚è§„èŒƒåŒ–çš„å¥½å¤„æ˜¯ä½ æ— éœ€é‡å¤´æ€è€ƒå¦‚ä½•å®ç°ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå®ç°ç¨‹åºçš„å¯ç†è§£æ€§é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿèƒ½é¿å…ä¸€ä¸å°å¿ƒå†™å‡ºä¸ªBugæ¥ã€‚ä½†Guarded Suspensionæ¨¡å¼åœ¨è§£å†³å®é™…é—®é¢˜çš„æ—¶å€™ï¼Œå¾€å¾€è¿˜æ˜¯éœ€è¦æ‰©å±•çš„ï¼Œæ‰©å±•çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæœ¬ç¯‡æ–‡ç« å°±ç›´æ¥å¯¹GuardedObjectçš„åŠŸèƒ½è¿›è¡Œäº†å¢å¼ºï¼ŒDubboä¸­DefaultFutureè¿™ä¸ªç±»ä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å¯¹æ¯”ç€æ¥çœ‹ï¼Œç›¸ä¿¡å¯¹DefaultFutureçš„å®ç°åŸç†ä¼šç†è§£å¾—æ›´é€å½»ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„ç±»æ¥å®ç°å¯¹Guarded Suspensionæ¨¡å¼çš„æ‰©å±•ã€‚</p><p>Guarded Suspensionæ¨¡å¼ä¹Ÿå¸¸è¢«ç§°ä½œGuarded Waitæ¨¡å¼ã€Spin Lockæ¨¡å¼ï¼ˆå› ä¸ºä½¿ç”¨äº†whileå¾ªç¯å»ç­‰å¾…ï¼‰ï¼Œè¿™äº›åå­—éƒ½å¾ˆå½¢è±¡ï¼Œä¸è¿‡å®ƒè¿˜æœ‰ä¸€ä¸ªæ›´å½¢è±¡çš„éå®˜æ–¹åå­—ï¼šå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifã€‚å•çº¿ç¨‹åœºæ™¯ä¸­ï¼Œifè¯­å¥æ˜¯ä¸éœ€è¦ç­‰å¾…çš„ï¼Œå› ä¸ºåœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„æ¡ä»¶ä¸‹ï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œé‚£å°±æ²¡æœ‰å…¶ä»–æ´»åŠ¨çº¿ç¨‹äº†ï¼Œè¿™æ„å‘³ç€ifåˆ¤æ–­æ¡ä»¶çš„ç»“æœä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–äº†ã€‚ä½†æ˜¯å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œç­‰å¾…å°±å˜å¾—æœ‰æ„ä¹‰äº†ï¼Œè¿™ç§åœºæ™¯ä¸‹ï¼Œifåˆ¤æ–­æ¡ä»¶çš„ç»“æœæ˜¯å¯èƒ½å‘ç”Ÿå˜åŒ–çš„ã€‚æ‰€ä»¥ï¼Œç”¨â€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€æ¥ç†è§£è¿™ä¸ªæ¨¡å¼ä¼šæ›´ç®€å•ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>æœ‰åŒå­¦è§‰å¾—ç”¨done.await()è¿˜è¦åŠ é”ï¼Œå¤ªå•°å—¦ï¼Œè¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨sleep()æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ä»–çš„å®ç°ï¼Œä½ è§‰å¾—ä»–çš„å†™æ³•æ­£ç¡®å—ï¼Ÿ</p><pre><code>//è·å–å—ä¿æŠ¤å¯¹è±¡  
T get(Predicate&lt;T&gt; p) {
  try {
    while(!p.test(obj)){
      TimeUnit.SECONDS
        .sleep(timeout);
    }
  }catch(InterruptedException e){
    throw new RuntimeException(e);
  }
  //è¿”å›éç©ºçš„å—ä¿æŠ¤å¯¹è±¡
  return obj;
}
//äº‹ä»¶é€šçŸ¥æ–¹æ³•
void onChanged(T obj) {
  this.obj = obj;
}
</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/cf/aa/cf393cd748a4f0e6451807c4b61843aa.jpg" alt=""></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é’è²  2019-05-09 08:30:40
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            sleep æ— æ³•è¢«å”¤é†’ï¼Œåªèƒ½æ—¶é—´åˆ°åè‡ªå·±æ¢å¤è¿è¡Œï¼Œå½“çœŸæ­£çš„æ¡ä»¶æ»¡è¶³äº†ï¼Œæ—¶é—´æœªåˆ°ï¼Œæ¥ç€ç¡çœ ï¼Œæ— æ€§èƒ½å¯è¨€ [8èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ™“æ°  2019-05-09 10:37:41
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç”¨sleepçš„è¯åªèƒ½ç­‰ç¡çœ æ—¶é—´åˆ°äº†ä¹‹åå†è¿”å›whileå¾ªç¯æ¡ä»¶å»åˆ¤æ–­ï¼Œä½†æ˜¯waitç›¸å½“äºå’Œsingalç»„æˆç­‰å¾…å”¤é†’çš„æœºåˆ¶ï¼Œè¿™æ ·æ»¡è¶³æ¡ä»¶çš„æ¦‚ç‡æ›´å¤§ä¸€äº›ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            åˆ˜ç« å‘¨  2019-05-09 10:01:33
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å½“ä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œwhileå¾ªç¯ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œæ°¸è¿œä¸ä¼šç»“æŸï¼Œå›å ç”¨å¤§é‡èµ„æºã€‚ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-09 22:32:22</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ğŸ‘</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ä¸‰  2019-05-10 09:04:02
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ¥å…¥å¾®ä¿¡æ”¯ä»˜æ”¯ä»˜å®æ”¯ä»˜é‡Œè¾¹ï¼Œä¹Ÿéœ€è¦æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ŒonChange()å°±æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°å§ï¼Œä¸è¿‡å¾®ä¿¡æ”¯ä»˜å®æ”¯ä»˜æ˜¯å¼‚æ­¥å›è°ƒï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥æ”¹æˆè¿™ç§ï¼Ÿå¾®ä¿¡æ”¯ä»˜å®é‡Œè¾¹çš„å…¶å®ƒç¬¬ä¸‰æ–¹æ”¯ä»˜æ˜¯ä¸æ˜¯å°±æ˜¯è¿™ç§æ¨¡å¼ï¼Œå› ä¸ºæ”¯ä»˜æˆåŠŸä¹‹åè·³è½¬åˆ°å®ƒä»¬è‡ªå·±çš„é¡µé¢ï¼Œè€Œä¸æ˜¯å¾®ä¿¡æ”¯ä»˜å®å®˜æ–¹çš„æ”¯ä»˜æˆåŠŸç•Œé¢ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Mr.Brooks  2019-05-10 08:43:46
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ²¡æœ‰é”ä¹Ÿæ— æ³•ä¿è¯å†…å­˜å¯è§æ€§å§ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ›¾è½¼éºŸ  2019-05-10 08:27:56
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            sleepä¼šæ— æ³•å”¤é†’å¯¼è‡´è¶…æ—¶ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨æ—¶é—´è½®HashTimeWheelçš„æ–¹å¼å»è®¾ç½®æ¯ä¸€æ¬¡è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æœ±æ™‹å›  2019-05-09 22:51:56
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆï¼Œå†é—®ä¸€ä¸‹ï¼Œå¦‚æœä¸ç”¨é”ï¼Œä¹Ÿä¸ç”¨awaitï¼Œnotifyï¼Œå°±ç”¨sleepï¼Œè·Ÿæœ€åä¸€æ®µä»£ç ä¸€æ ·ã€‚<br>åœ¨testæ–¹æ³•ä¸­åŠ objæ£€éªŒï¼Œé™¤äº†sleepå”¤é†’é—®é¢˜å¤–ï¼Œä¼šæœ‰ä»€ä¹ˆå…¶ä»–é—®é¢˜å‘¢ï¼Ÿ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ä¸‰  2019-05-09 21:22:29
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ‰“å¡ï¼ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ©˜å­  2019-05-09 21:18:38
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è¿™è®©æˆ‘æƒ³åˆ°äº†ä¹‹å‰å¾ˆç«çš„sleepæ’åºç®—æ³•ï¼Œå“ˆå“ˆ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æœ±æ™‹å›  2019-05-09 09:38:52
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¦‚æœä»¥æ–‡ä¸­çš„æœ€åä¸€æ®µç¤ºä¾‹ä»£ç æ¥çœ‹ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ç”Ÿæˆä¸€ä¸ªidï¼Œå¯¹åº”ä¸€ä¸ªGuardedObjectï¼Œå¹¶æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚æˆ‘è§‰å¾—å¯ä»¥å»æ‰é”ã€‚<br>ä½†æ˜¯åŠ sleepçš„è¯ï¼Œæ²¡æœ‰åŠæ³•å”¤é†’ï¼Œåªèƒ½ç­‰åˆ°è¶…æ—¶ã€‚ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-09 22:23:59</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">awaitå’Œnotifyè·å–é”æ‰èƒ½è°ƒç”¨ï¼Œæ‰€ä»¥ä¸èƒ½å»æ‰é”</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é”¦  2019-05-09 09:30:46
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            <br><br>è€å¸ˆï¼Œé—®ä¸ªç»†èŠ‚é—®é¢˜ï¼šå°±é¤äººä¸é¤æ¡Œçš„å…³ç³»ä¸æ˜¯åœ¨å¤§å ‚ç»ç†è„‘ä¸­å—ï¼Ÿæ€ä¹ˆå†™åœ¨å°±é¤äººçš„å†…éƒ¨å‘¢ï¼Ÿæ˜¯å› ä¸ºGuardedObjectçš„ç±»æœ¬èº«å……å½“çš„å¤§å ‚ç»ç†è§’è‰²ï¼Œç±»å®ä¾‹å……å½“å°±é¤äººè§’è‰²å—ï¼Ÿ<br>å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å¤§å ‚ç»ç†æ˜¯å”¯ä¸€çš„å—ï¼Ÿ<br><br>å›ç­”é—®é¢˜ï¼šæ”¹æˆsleepä¸åŠ é”å°±å˜æˆçº¿ç¨‹ä¸å®‰å…¨çš„å¿™ç­‰å¾…æ¨¡å¼ï¼Œåº”è¯¥ä¸ç¬¦åˆéœ€æ±‚ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ™“æ°  2019-05-09 09:17:17
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è¯·é—®è€å¸ˆMQä¸æ˜¯å¯ä»¥ç‚¹å¯¹ç‚¹å—ï¼Œé‚£æœåŠ¡æä¾›æ–¹ä¸å¯ä»¥æŒ‡å®šæ¶ˆè´¹æŸæ¡æ¶ˆæ¯å—ï¼Œè¿™æ ·çº¿ç¨‹Tæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è·å¾—MQè¿”å›çš„ç»“æœ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-09 22:25:56</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥è·å–ä¸åˆ°<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            kyle  2019-05-09 08:52:00
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            Java8çš„æ— æ³•çš„è¡¥è¡¥ï¼ğŸ˜° 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶  2019-05-09 08:36:21
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç­‰å¾…ä¸ç¡®å®šæ—¶å“ªä¸ªçº¿ç¨‹æˆåŠŸï¼Œç­‰å¾…æ—¶é—´å›ºå®šï¼Œä¸ç²¾ç¡® 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            zero  2019-05-09 07:40:32
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            waitä¼šé‡Šæ”¾å æœ‰çš„èµ„æºï¼Œsleepä¸ä¼šé‡Šæ”¾ 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>